/*! MMTS-Hyderabad-ChromeExtension 03-08-2014 */
"use strict";angular.module("mmts",["ngRoute","LocalStorageModule"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"templates/default.html",controller:"defaultController"}).when("/searchtrains",{templateUrl:"templates/searchtrains.html",controller:"searchTrainsController"}).when("/livetrains",{templateUrl:"templates/livetrains.html",controller:"liveTrainController"}).otherwise("/")}]),angular.module("mmts").controller("defaultController",["$scope","$location","stationsService","sharedService",function(a,b,c,d){function e(){if(null!=d.fromStation||null!=d.toStation)for(var b=a.stations.length-1;b>=0;b--)null!=d.fromStation&&a.stations[b].value==d.fromStation&&(a.station.from=a.stations[b]),null!=d.toStation&&a.stations[b].value==d.toStation&&(a.station.to=a.stations[b]),f()}function f(){a.isValid=!1,g(a.station.to)&&g(a.station.from)&&(a.isValid=!0),_.isEqual(a.station.to,a.station.from)&&(a.isValid=!1)}function g(a){return"undefined"!=typeof a&&null!=a}a.station={},a.isValid=!1;var h=c.getStations();h.then(function(b){a.stations=b,d.stations=b,e()},function(){console.log("An error occured while reading the file")}),a.updateStation=function(a,b){switch(a){case"from":d.updateFromStation(b);break;case"to":d.updateToStation(b)}f()},a.interchange=function(){var b=a.station.from;a.station.from=a.station.to,a.station.to=b,a.updateStation("to",a.station.to),a.updateStation("from",a.station.from)},a.performSearch=function(){var c="/searchtrains";b.search("from",a.station.from.value).search("to",a.station.to.value).path(c)}}]),angular.module("mmts").controller("searchTrainsController",["$scope","$routeParams","sharedService","trainsService",function(a,b,c,d){a.search={},function(){for(var e=c.stations.length-1;e>=0;e--)c.stations[e].value===b.from&&(a.search.from=c.stations[e]),c.stations[e].value===b.to&&(a.search.to=c.stations[e]);d.getTrains(a.search.from,a.search.to).then(function(b){a.trains=b},function(){})}(),a.getClass=function(a){return a.RunsOnSunday?"row no-left-margin no-right-margin no-bottom-margin top-margin-10 sunday":"row no-left-margin no-right-margin no-bottom-margin top-margin-10 no-sunday"}}]),angular.module("mmts").factory("stationsService",["$http","$q","workerService",function(a,b,c){var d={};return d.getStations=function(){var a=b.defer();return c.readFile("./data/stations.json").then(function(b){a.resolve(b)},function(b){a.reject(b)}),a.promise},d}]),angular.module("mmts").factory("trainsService",["$http","$q","workerService","sharedService",function(a,b,c){var d=[47109,47110,47111,47112,47133,47134,47135,47136,47137,47158,47138,47160,47161,47179,47182,47184,47198,47199,47208,47209],e={};e.getTrains=function(a,d){var e=b.defer();return c.readFile("./data/trains.json").then(function(b){var c=[],g=_.map(_.filter(b,function(b){return b.stationname===a.name}),function(a){return a.trainname}),h=_.map(_.filter(_.filter(b,function(a){return _.contains(g,a.trainname)}),function(a){return a.stationname===d.name}),function(a){return a.trainname}),i=_.filter(_.filter(b,function(a){return _.contains(h,a.trainname)}),function(b){return b.stationname===a.name}),j=_.filter(_.filter(b,function(a){return _.contains(h,a.trainname)}),function(a){return a.stationname===d.name});j.length===i.length&&_.each(i,function(a,b){var d=f(i[b],j[b]);null!=d&&c.push(d)}),c=_.sortBy(c,"Departure"),e.resolve(c)},function(a){e.reject(a)}),e.promise};var f=function(a,b){if(a.arrivaltime<b.arrivaltime){var c={};return c.TrainNumber=a.trainname,c.Departure=a.arrivaltime,c.Arrival=b.arrivaltime,c.RunsOnSunday=!0,_.contains(d,c.TrainNumber)&&(c.RunsOnSunday=!1),c}return null};return e}]),angular.module("mmts").factory("workerService",["$http","$q",function(a,b){var c={};return c.readFile=function(c){var d=b.defer();return a.get(c).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},c}]),angular.module("mmts").factory("sharedService",["localStorageService","workerService",function(a){var b={};return b.fromStation=a.get("from"),b.toStation=a.get("to"),b.updateFromStation=function(c){b.fromStation=c.value,a.set("from",c.value)},b.updateToStation=function(c){b.toStation=c.value,a.set("to",c.value)},b}]),angular.module("mmts").directive("result",function(){return{restrict:"E",replace:!0,templateUrl:"./templates/result.html"}});